<script>
    feather.replace();

    const chatForm = document.getElementById('chatForm');
    const userInput = document.getElementById('userInput');
    const chatContainer = document.getElementById('chatContainer');
    const typingIndicator = document.getElementById('typingIndicator');

    function addMessage(text, sender = 'bot', extras = {}) {
        const wrapper = document.createElement('div');
        wrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-6`;

        let content = `
            <div class="${sender === 'user'
                ? 'bg-white-600 text-blue'
                : 'bg-gray text-black-800'} rounded-lg p-4 shadow message">
                ${text}
            </div>
        `;

        wrapper.innerHTML = content;
        chatContainer.appendChild(wrapper);

        // Add extra buttons if available
        if (sender === 'bot') {
            if (extras.precautions && extras.precautions.length > 0) {
                const pDiv = document.createElement('div');
                pDiv.className = "mt-2 space-x-2";
                extras.precautions.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = "action-btn bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm hover:bg-blue-200 transition";
                    btn.textContent = "Precaution: " + item;
                    btn.onclick = () => addMessage(item, 'user');
                    pDiv.appendChild(btn);
                });
                wrapper.appendChild(pDiv);
            }

            if (extras.actions && extras.actions.length > 0) {
                const aDiv = document.createElement('div');
                aDiv.className = "mt-2 space-x-2";
                extras.actions.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = "action-btn bg-green-100 text-green-600 px-3 py-1 rounded-full text-sm hover:bg-green-200 transition";
                    btn.textContent = "Action: " + item;
                    btn.onclick = () => addMessage(item, 'user');
                    aDiv.appendChild(btn);
                });
                wrapper.appendChild(aDiv);
            }
        }

        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const question = userInput.value.trim();
        if (!question) return;

        // User message
        addMessage(question, 'user');
        userInput.value = '';

        // Show typing
        typingIndicator.classList.remove('hidden');
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: question })
            });

            const data = await res.json();
            typingIndicator.classList.add('hidden');

            // Bot response + extras
            addMessage(data.response, 'bot', {
                precautions: data.precautions,
                actions: data.actions
            });

        } catch (err) {
            typingIndicator.classList.add('hidden');
            addMessage("⚠️ Error: could not reach server.", 'bot');
        }
    });
</script>
